<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebInsight AI - 智能網站分析師</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #020617; /* Deep Slate */
            color: #e2e8f0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .message-user {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 12px 12px 0 12px;
        }
        .message-ai {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px 12px 12px 0;
            border: 1px solid #334155;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        .popover-enter { animation: popIn 0.2s ease-out forwards; }
        @keyframes popIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // --- 設定區 ---
    const CONFIG = {
        GEMINI_API_KEY: "AIzaSyAuH8gZ-BdtSq1S2EYvOMxrBFaFl2g-ePU", 
        JINA_API_KEY: "jina_d9fc3cb689f545fb9cd81f2301508417kjelTyrF7Og8VwdzG5O9kQ9nB-z8"    
    };

    // --- UI Component: SmartText ---
    const SmartText = ({ text, className, colorClass }) => {
        const [showTooltip, setShowTooltip] = useState(false);
        const wrapperRef = useRef(null);

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                    setShowTooltip(false);
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            document.addEventListener("touchstart", handleClickOutside);
            return () => {
                document.removeEventListener("mousedown", handleClickOutside);
                document.removeEventListener("touchstart", handleClickOutside);
            };
        }, []);

        return (
            <div 
                ref={wrapperRef}
                className="relative inline-block w-full"
                onMouseEnter={() => setShowTooltip(true)}
                onMouseLeave={() => setShowTooltip(false)}
            >
                <div 
                    className={`truncate cursor-help ${className} ${colorClass}`}
                    onClick={() => setShowTooltip(!showTooltip)}
                >
                    {text}
                </div>
                {showTooltip && (
                    <div className="absolute bottom-full left-0 mb-2 w-max max-w-[250px] p-3 bg-slate-800/95 backdrop-blur border border-slate-600 rounded-xl shadow-2xl z-50 popover-enter">
                        <div className="text-xs text-slate-400 mb-1">完整內容：</div>
                        <div className="text-sm text-white whitespace-normal break-words leading-relaxed font-medium">
                            {text}
                        </div>
                        <div className="absolute -bottom-1 left-4 w-2 h-2 bg-slate-800 border-b border-r border-slate-600 transform rotate-45"></div>
                    </div>
                )}
            </div>
        );
    };

    // --- Chart Components ---
    const RadarChart = ({ data }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current || !data) return;
            if (chartRef.current) chartRef.current.destroy();

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: data.map(d => d.subject),
                    datasets: [{
                        label: '能力評分',
                        data: data.map(d => d.A),
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        pointBackgroundColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#94a3b8', font: { size: 11 } },
                            ticks: { display: false, backdropColor: 'transparent' },
                            suggestedMin: 0, suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            return () => chartRef.current?.destroy();
        }, [data]);
        return <canvas ref={canvasRef} />;
    };

    const BarChart = ({ data }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current || !data) return;
            if (chartRef.current) chartRef.current.destroy();

            const ctx = canvasRef.current.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 400, 0);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradient.addColorStop(1, 'rgba(147, 51, 234, 0.8)');

            chartRef.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: '權重',
                        data: data.map(d => d.score),
                        backgroundColor: gradient,
                        borderRadius: 4,
                        barThickness: 20,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#64748b' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { 
                                color: '#e2e8f0', 
                                font: { weight: 'bold' },
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 8) return label.substr(0, 8) + '...';
                                    return label;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(51, 65, 85, 1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(context) { return context[0].label; }
                            }
                        }
                    }
                }
            });
            return () => chartRef.current?.destroy();
        }, [data]);
        return <canvas ref={canvasRef} />;
    };

    // --- Main App Logic ---
    const App = () => {
        const [hasError, setHasError] = useState(false);
        const [globalErrorMsg, setGlobalErrorMsg] = useState("");

        if (hasError) {
            return (
                <div className="flex items-center justify-center h-screen bg-slate-900 text-white p-10 text-center">
                    <div>
                        <h1 className="text-3xl font-bold text-red-500 mb-4">系統錯誤</h1>
                        <p className="text-slate-400 mb-4">{globalErrorMsg}</p>
                        <button onClick={() => window.location.reload()} className="px-4 py-2 bg-blue-600 rounded">重新整理</button>
                    </div>
                </div>
            );
        }

        try {
            const [activeTab, setActiveTab] = useState('dashboard'); 
            const [urlInput, setUrlInput] = useState("");
            const [isReading, setIsReading] = useState(false);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            
            const [readContent, setReadContent] = useState(null);
            const [sourceTitle, setSourceTitle] = useState("");
            const [analysisData, setAnalysisData] = useState(null);
            
            const [chatInput, setChatInput] = useState("");
            const [messages, setMessages] = useState([
                { role: 'system', content: 'WebInsight 核心已啟動。請輸入網址以開始分析。' }
            ]);
            const [isChatLoading, setIsChatLoading] = useState(false);
            const [appErrorMsg, setAppErrorMsg] = useState("");
            
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const chatEndRef = useRef(null);

            useEffect(() => {
                if (activeTab === 'chat') {
                    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages, isChatLoading, activeTab]);

            const performDeepAnalysis = async (title, content) => {
                setIsAnalyzing(true);
                try {
                    const prompt = `
                    作為首席網站分析師，請分析以下內容並回傳 **純 JSON** (無 markdown)。
                    網站：${title}
                    內容摘要：${content.substring(0, 10000)}
                    
                    JSON 結構需求：
                    {
                        "summary": "一句話專業點評 (30字內)",
                        "keywords": [
                            {"name": "關鍵詞1", "score": 95},
                            {"name": "關鍵詞2", "score": 85},
                            ...共5-6個
                        ],
                        "radar": [
                            {"subject": "內容深度", "A": 85},
                            {"subject": "易讀性", "A": 90},
                            {"subject": "SEO優化", "A": 70},
                            {"subject": "變現潛力", "A": 60},
                            {"subject": "品牌識別", "A": 80},
                            {"subject": "技術質量", "A": 75}
                        ],
                        "metrics": {
                            "estimatedValue": "$USD 估值",
                            "targetAudience": "詳細目標客群 (可稍長)",
                            "sentiment": "情緒 (正向/中立/負向)",
                            "readingTime": "閱讀時長 (min)"
                        },
                        "insights": [
                            "洞察 1...",
                            "洞察 2...",
                            "洞察 3..."
                        ]
                    }
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: 'user', parts: [{ text: prompt }] }]
                        })
                    });

                    const data = await response.json();
                    let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                    rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const jsonResult = JSON.parse(rawText);
                    
                    setAnalysisData(jsonResult);
                    setActiveTab('dashboard');
                    setIsMobileMenuOpen(false); 

                } catch (err) {
                    console.error("Analysis Failed", err);
                    setAppErrorMsg("數據解析失敗，請稍後重試。");
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const handleReadUrl = async () => {
                if (!urlInput) return;
                if (!CONFIG.GEMINI_API_KEY) {
                    setAppErrorMsg("錯誤：未配置 Gemini API Key");
                    return;
                }

                setIsReading(true);
                setAppErrorMsg("");
                setReadContent(null);
                setAnalysisData(null);
                
                try {
                    let targetUrl = urlInput.trim();
                    if (!targetUrl.startsWith('http')) {
                        targetUrl = `https://${targetUrl}`;
                    }

                    const jinaUrl = `https://r.jina.ai/${targetUrl}`;
                    const headers = { 'Accept': 'application/json' };
                    if (CONFIG.JINA_API_KEY) headers['Authorization'] = `Bearer ${CONFIG.JINA_API_KEY}`;

                    let response;
                    try {
                        response = await fetch(jinaUrl, { headers });
                        if (!response.ok) throw new Error('Direct fetch failed');
                    } catch (directError) {
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(jinaUrl)}`;
                        response = await fetch(proxyUrl);
                    }

                    if (!response.ok) throw new Error(`讀取失敗 (${response.status})`);

                    const data = await response.json();
                    
                    const content = data.data?.content || data.data?.text || data.content || "";
                    const title = data.data?.title || data.title || targetUrl;

                    if (!content || content.length < 50) throw new Error("內容過短或被阻擋");

                    setReadContent(content);
                    setSourceTitle(title);
                    
                    setMessages(prev => [...prev, { 
                        role: 'system', 
                        content: `✅ 資料同步完成：**${title}**\n正在啟動神經網絡分析...` 
                    }]);
                    
                    await performDeepAnalysis(title, content);

                } catch (err) {
                    console.error(err);
                    setAppErrorMsg(`讀取錯誤：${err.message}`);
                    setMessages(prev => [...prev, { role: 'system', content: `❌ 錯誤：${err.message}` }]);
                } finally {
                    setIsReading(false);
                }
            };

            const handleSendMessage = async () => {
                if (!chatInput.trim() || isChatLoading) return;
                
                const userText = chatInput;
                setChatInput("");
                setMessages(prev => [...prev, { role: 'user', content: userText }]);
                setIsChatLoading(true);

                try {
                    let sysPrompt = "你是一個專業的數據分析師。請基於以下數據回答問題。";
                    if (readContent) sysPrompt += `\n\n[網站內容]\n${readContent.substring(0, 15000)}`;
                    if (analysisData) sysPrompt += `\n\n[分析報告]\n${JSON.stringify(analysisData)}`;

                    const history = messages.filter(m => m.role !== 'system').map(m => ({
                        role: m.role === 'user' ? 'user' : 'model',
                        parts: [{ text: m.content }]
                    }));

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: 'user', parts: [{ text: sysPrompt }] }, ...history, { role: 'user', parts: [{ text: userText }] }]
                        })
                    });

                    const data = await response.json();
                    const aiReply = data.candidates?.[0]?.content?.parts?.[0]?.text || "無法回應";
                    setMessages(prev => [...prev, { role: 'ai', content: aiReply }]);

                } catch (err) {
                    setMessages(prev => [...prev, { role: 'system', content: `⚠️ 錯誤: ${err.message}` }]);
                } finally {
                    setIsChatLoading(false);
                }
            };

            return (
                <div className="flex h-screen relative">
                    
                    {/* --- Mobile Header (手機版頂部導航) --- */}
                    <div className="fixed top-0 left-0 right-0 h-16 bg-[#0f172a]/90 backdrop-blur-md z-30 border-b border-slate-800 flex items-center justify-between px-4 md:hidden shadow-lg">
                        <button 
                            onClick={() => setIsMobileMenuOpen(true)}
                            className="p-2 text-slate-300 hover:text-white rounded-lg hover:bg-slate-800 transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <div className="flex items-center gap-2">
                             <h1 className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                                WebInsight
                            </h1>
                        </div>
                        <div className="w-10"></div> {/* Spacer for center alignment */}
                    </div>

                    {/* 手機版遮罩 */}
                    {isMobileMenuOpen && (
                        <div 
                            className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm transition-opacity"
                            onClick={() => setIsMobileMenuOpen(false)}
                        />
                    )}

                    {/* 側邊導航欄 */}
                    <div className={`
                        fixed inset-y-0 left-0 z-50 w-80 bg-[#0f172a] border-r border-slate-800 flex flex-col shadow-2xl transition-transform duration-300 ease-in-out
                        md:relative md:translate-x-0 md:shadow-none
                        ${isMobileMenuOpen ? "translate-x-0" : "-translate-x-full"}
                    `}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center h-20 md:h-auto">
                            <div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                    WebInsight
                                </h1>
                                <p className="text-slate-500 text-[10px] uppercase tracking-[0.2em] mt-1 ml-8">AI 網站智能分析</p>
                            </div>
                            <button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden text-slate-400 hover:text-white p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>

                        <div className="p-4 space-y-6 flex-1 overflow-y-auto">
                            <div className="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                                <label className="text-xs font-semibold text-slate-400 mb-2 block uppercase">目標 URL</label>
                                <input 
                                    type="text" 
                                    value={urlInput}
                                    onChange={(e) => setUrlInput(e.target.value)}
                                    placeholder="google.com"
                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-blue-100 focus:border-blue-500 focus:outline-none mb-3"
                                />
                                <button 
                                    onClick={handleReadUrl}
                                    disabled={isReading || !urlInput}
                                    className={`w-full py-2 rounded-lg text-xs font-bold transition-all ${
                                        isReading ? 'bg-slate-700 text-slate-400' : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/40'
                                    }`}
                                >
                                    {isReading ? '正在連接節點...' : isAnalyzing ? '正在分析數據...' : '開始深度分析'}
                                </button>
                            </div>

                            <div className="space-y-1">
                                <button 
                                    onClick={() => { setActiveTab('dashboard'); setIsMobileMenuOpen(false); }} 
                                    className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all ${activeTab === 'dashboard' ? 'bg-slate-800 text-blue-400 border border-slate-700' : 'text-slate-400 hover:bg-slate-800/30'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                                    數據儀表板
                                </button>
                                <button 
                                    onClick={() => { setActiveTab('chat'); setIsMobileMenuOpen(false); }} 
                                    className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all ${activeTab === 'chat' ? 'bg-slate-800 text-blue-400 border border-slate-700' : 'text-slate-400 hover:bg-slate-800/30'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    智能諮詢室
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* 主區域 (需預留頂部空間 pt-16 給 Header) */}
                    <div className="flex-1 relative bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black overflow-hidden flex flex-col w-full pt-16 md:pt-0">
                        
                        {/* 錯誤提示 */}
                        {appErrorMsg && (
                            <div className="absolute top-20 md:top-6 left-1/2 transform -translate-x-1/2 z-30 animate-bounce w-[90%] md:w-auto flex justify-center">
                                <div className="bg-red-500/90 text-white px-6 py-2 rounded-full shadow-lg text-sm backdrop-blur-md text-center">
                                    {appErrorMsg}
                                </div>
                            </div>
                        )}

                        {/* DASHBOARD VIEW */}
                        {activeTab === 'dashboard' && (
                            <div className="flex-1 overflow-y-auto p-4 md:p-10 space-y-6 md:space-y-8 pb-10">
                                {!analysisData ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-600 space-y-4">
                                        <div className="w-20 h-20 border-2 border-slate-700 rounded-full flex items-center justify-center animate-pulse">
                                            <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                        </div>
                                        <p className="text-sm font-light tracking-widest uppercase">等待數據注入...</p>
                                        <p className="text-xs text-slate-500 md:hidden">(請點擊左上角選單輸入網址)</p>
                                    </div>
                                ) : (
                                    <>
                                        {/* Header */}
                                        <div className="fade-in-up" style={{animationDelay: '0ms'}}>
                                            <h2 className="text-2xl md:text-3xl font-bold text-white mb-2 truncate">{sourceTitle}</h2>
                                            <p className="text-blue-400 font-mono text-sm border-l-4 border-blue-500 pl-4 py-1 bg-blue-500/10 rounded-r">
                                                {analysisData.summary}
                                            </p>
                                        </div>

                                        {/* KPI Cards */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 fade-in-up" style={{animationDelay: '100ms'}}>
                                            <div className="glass-panel p-4 md:p-5 rounded-xl">
                                                <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">預估價值</div>
                                                <SmartText text={analysisData.metrics.estimatedValue} colorClass="text-emerald-400 font-bold text-lg md:text-xl" />
                                            </div>
                                            <div className="glass-panel p-4 md:p-5 rounded-xl">
                                                <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">目標受眾</div>
                                                <SmartText text={analysisData.metrics.targetAudience} colorClass="text-white font-bold text-lg md:text-xl" />
                                            </div>
                                            <div className="glass-panel p-4 md:p-5 rounded-xl">
                                                <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">情感傾向</div>
                                                <SmartText text={analysisData.metrics.sentiment} colorClass="text-blue-400 font-bold text-lg md:text-xl" />
                                            </div>
                                            <div className="glass-panel p-4 md:p-5 rounded-xl">
                                                <div className="text-slate-500 text-[10px] uppercase tracking-wider mb-1">閱讀時長</div>
                                                <SmartText text={`${analysisData.metrics.readingTime} min`} colorClass="text-purple-400 font-bold text-lg md:text-xl" />
                                            </div>
                                        </div>

                                        {/* Charts */}
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 fade-in-up" style={{animationDelay: '200ms'}}>
                                            <div className="glass-panel p-4 md:p-6 rounded-2xl flex flex-col h-[350px] md:h-[400px]">
                                                <h3 className="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                                                    <span className="w-2 h-2 rounded-full bg-purple-500"></span> 六維能力評估
                                                </h3>
                                                <div className="flex-1 relative">
                                                    <RadarChart data={analysisData.radar} />
                                                </div>
                                            </div>

                                            <div className="glass-panel p-4 md:p-6 rounded-2xl flex flex-col h-[350px] md:h-[400px]">
                                                <h3 className="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                                                    <span className="w-2 h-2 rounded-full bg-blue-500"></span> 核心關鍵詞權重
                                                </h3>
                                                <div className="flex-1 relative">
                                                    <BarChart data={analysisData.keywords} />
                                                </div>
                                                <p className="text-[10px] text-slate-500 text-center mt-2">點擊長條可查看完整名稱</p>
                                            </div>
                                        </div>

                                        {/* Insights */}
                                        <div className="glass-panel p-4 md:p-6 rounded-2xl fade-in-up" style={{animationDelay: '300ms'}}>
                                            <h3 className="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                                                <svg className="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                AI 戰略洞察
                                            </h3>
                                            <div className="space-y-3">
                                                {analysisData.insights.map((insight, idx) => (
                                                    <div key={idx} className="flex gap-3 text-sm text-slate-300 items-start">
                                                        <span className="bg-slate-700/50 text-slate-400 rounded px-2 py-0.5 text-xs font-mono mt-0.5 shrink-0">#{idx + 1}</span>
                                                        <span className="leading-relaxed opacity-90">{insight}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* CHAT VIEW */}
                        {activeTab === 'chat' && (
                            <div className="flex flex-col h-full">
                                <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-4 md:pb-8">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] md:max-w-[70%] p-4 shadow-xl backdrop-blur-sm ${
                                                msg.role === 'user' ? 'message-user' : 
                                                msg.role === 'system' ? 'bg-transparent border border-dashed border-slate-700 text-slate-500 text-xs w-full text-center' : 'message-ai'
                                            }`}>
                                                {msg.role === 'ai' || msg.role === 'system' ? (
                                                    <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} />
                                                ) : (
                                                    <div className="whitespace-pre-wrap text-sm">{msg.content}</div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {isChatLoading && (
                                        <div className="flex justify-start">
                                            <div className="message-ai p-4 flex gap-1 items-center">
                                                <div className="w-1.5 h-1.5 bg-blue-400 rounded-full typing-dot"></div>
                                                <div className="w-1.5 h-1.5 bg-blue-400 rounded-full typing-dot"></div>
                                                <div className="w-1.5 h-1.5 bg-blue-400 rounded-full typing-dot"></div>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={chatEndRef} />
                                </div>

                                <div className="p-4 bg-[#0f172a]/80 backdrop-blur border-t border-slate-800">
                                    <div className="max-w-4xl mx-auto flex gap-3 items-end">
                                        <textarea 
                                            value={chatInput}
                                            onChange={(e) => setChatInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if(e.key === 'Enter' && !e.shiftKey) {
                                                    e.preventDefault();
                                                    handleSendMessage();
                                                }
                                            }}
                                            placeholder="輸入問題，諮詢詳細策略..."
                                            className="flex-1 bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:outline-none focus:border-blue-500 resize-none h-12 max-h-32 shadow-inner"
                                        />
                                        <button 
                                            onClick={handleSendMessage}
                                            disabled={isChatLoading || !chatInput.trim()}
                                            className="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white flex items-center justify-center transition-all disabled:opacity-50 shadow-lg shrink-0"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        } catch (error) {
            setHasError(true);
            setGlobalErrorMsg(error.message);
            return null;
        }
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>