<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruby's Forest | æ˜Ÿè¾°æ£®æ—çš„ç´”æ·¨ä¹‹å…‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Serif+TC:wght@500;900&display=swap');

        :root {
            --berry-red: #d90429; 
            --berry-glow: rgba(217, 4, 41, 0.6);
            --firefly-yellow: #f1c40f;
            --firefly-orange: #f39c12;
            --cave-blue: #93c5fd; 
            --cave-blue-glow: rgba(147, 197, 253, 0.8);
            --lime-green: #a3e635;
            --lime-glow: rgba(163, 230, 53, 0.5);
            --cyber-pink: #ff00ff;
        }

        body {
            margin: 0; background-color: #010409; color: #ffffff;
            font-family: 'Inter', 'Noto Serif TC', serif; overflow-x: hidden;
            -webkit-font-smoothing: antialiased; touch-action: auto;
        }

        /* å¯¦é«”å±¤ */
        #magic-entities-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 140; overflow: hidden;
        }

        .forest-layers { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: -1; background: radial-gradient(circle at 50% 50%, #022c22 0%, #010409 100%); }
        .tree { position: absolute; bottom: -50px; fill: #001a14; opacity: 0.6; transform-origin: bottom center; }
        .grass-layer { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; z-index: 10; pointer-events: none; background: linear-gradient(to top, #010409 20%, transparent 100%); }

        .section-container {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            position: relative; padding: 2rem; opacity: 0; z-index: 20;
        }

        .title-glow {
            color: #ffffff;
            text-shadow: 
                0 0 10px rgba(243, 156, 18, 0.6), 
                0 0 25px rgba(243, 156, 18, 0.3),
                2px 2px 8px rgba(0, 0, 0, 0.6);
            letter-spacing: -0.02em;
        }

        #portal-controls-group {
            position: fixed; top: 24px; left: 24px; z-index: 200; display: flex; align-items: center; gap: 16px;
        }

        /* å³ä¸Šè§’æ§åˆ¶éˆ•ç¾¤çµ„ */
        #top-right-controls {
            position: fixed; top: 24px; right: 24px; z-index: 200; display: flex; gap: 12px;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50%;
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            color: rgba(255, 255, 255, 0.4); transition: all 0.3s ease;
            cursor: pointer; outline: none;
        }
        .control-btn:hover { border-color: var(--berry-red); color: var(--berry-red); box-shadow: 0 0 15px rgba(217, 4, 41, 0.3); }
        .control-btn.active { color: var(--berry-red); border-color: var(--berry-red); box-shadow: 0 0 20px var(--berry-glow); }

        /* éœ²æ¯”ç²¾éˆæ¨£å¼ */
        #forest-sprite { 
            position: fixed; width: 80px; height: 80px; z-index: 150; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; pointer-events: auto;
        }
        .sprite-body {
            width: 32px; height: 32px; background: radial-gradient(circle, #fff 0%, var(--berry-red) 70%); border-radius: 50%; 
            box-shadow: 0 0 25px var(--berry-red), 0 0 50px var(--berry-glow);
            z-index: 2;
        }
        .sprite-dialogue-wrapper {
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; z-index: 10;
        }
        .sprite-dialogue-wrapper.active { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }

        .sprite-dialogue {
            background: rgba(10, 0, 0, 0.9); backdrop-filter: blur(10px); padding: 12px 18px; border-radius: 16px; border: 1px solid var(--berry-red);
            min-width: 200px; max-width: 280px; color: #fca5a5; font-size: 0.85rem; text-align: center; line-height: 1.5;
            box-shadow: 0 10px 25px rgba(217, 4, 41, 0.2);
        }
        
        .sprite-input-box {
            width: 180px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(217, 4, 41, 0.3);
            border-radius: 20px; padding: 6px 15px; color: #fff; font-size: 0.75rem; outline: none; text-align: center;
        }

        /* --- é­”æ³•ç²’å­ç‰¹æ•ˆæ¨£å¼ --- */
        .magic-particle {
            position: fixed; pointer-events: none; border-radius: 50%; z-index: 144;
        }
        .lightning-spark {
            position: fixed; pointer-events: none; width: 1px; height: 20px; background: #fff;
            box-shadow: 0 0 12px #00f2ff, 0 0 20px #ff00ff; z-index: 146; transform-origin: center;
        }
        .snowflake {
            position: fixed; pointer-events: none; background: white; z-index: 1200;
        }

        #teleport-portal-svg {
            position: fixed; width: 320px; height: 320px; pointer-events: none; z-index: 145;
            opacity: 0; transform: translate(-50%, -50%);
        }
        .magic-path {
            fill: none; stroke: var(--cyber-pink); stroke-width: 4; stroke-linecap: round; filter: drop-shadow(0 0 15px var(--cyber-pink)); stroke-dasharray: 1000; stroke-dashoffset: 1000;
        }
        .magic-circle-path {
            fill: none; stroke: var(--cyber-pink); stroke-width: 1.5; opacity: 0.6; stroke-dasharray: 1000; stroke-dashoffset: 1000;
        }

        #warp-flash { position: fixed; inset: 0; background: white; z-index: 1300; opacity: 0; pointer-events: none; }
        #blizzard-overlay { position: fixed; inset: 0; background: #000; z-index: 999; opacity: 0; pointer-events: none; }

        .instruction-bar {
            position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); z-index: 100;
            display: flex; align-items: center; justify-content: center; width: auto; max-width: 95vw; padding: 8px 24px;
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(8px); border-radius: 100px; border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none; transition: all 0.5s ease;
        }
        .instruction-text { color: rgba(255, 255, 255, 0.45); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
        .highlight-cmd { color: var(--berry-red); font-weight: 900; }

        #scene-title-overlay { position: fixed; bottom: 45px; left: 35px; z-index: 1000; pointer-events: none; opacity: 0; }
        #overlay-text { color: var(--lime-green); text-shadow: 0 0 15px var(--lime-glow); opacity: 0.2; font-weight: 900; letter-spacing: 0.05em; }

        .sidebar { position: fixed; left: 1.5rem; top: 50%; transform: translateY(-50%); z-index: 100; display: flex; flex-direction: column; gap: 1.5rem; }
        .nav-item { display: flex; align-items: center; gap: 1rem; color: rgba(255, 255, 255, 0.2); transition: all 0.3s; }
        .nav-item.active { color: rgba(255, 255, 255, 0.5); }
        .nav-text { opacity: 0; transition: opacity 0.5s ease; font-weight: bold; color: #fff; text-shadow: 0 0 10px var(--firefly-yellow); }
        .nav-item.trigger-show .nav-text { opacity: 0.3; }

        .spawn-point { position: absolute; z-index: 60; top: 10%; left: 5%; cursor: pointer; text-align: center; }
        .cave-style { color: var(--cave-blue); filter: drop-shadow(0 0 20px var(--cave-blue-glow)); animation: cave-pulse 4s ease-in-out infinite; }
        @keyframes cave-pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }

        .creature { position: absolute; pointer-events: none; z-index: 142; }
        .bat-monster { position: absolute; pointer-events: none; z-index: 145; display: flex; align-items: center; justify-content: center; font-size: 4rem; }
        .magic-note { z-index: 200; color: var(--firefly-yellow); text-shadow: 0 0 15px var(--firefly-orange); font-size: 2rem; position: absolute; pointer-events: none; }

        /* æ•…äº‹æ®µè½æ¨£å¼ */
        .story-block {
            background: rgba(0, 0, 0, 0.4); border-left: 3px solid var(--berry-red); padding: 1.5rem; border-radius: 0 20px 20px 0;
            backdrop-blur: 10px; border: 1px solid rgba(255, 255, 255, 0.05);
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            h1 { font-size: 2.8rem !important; line-height: 1.3; }
            .instruction-bar { bottom: 85px; max-width: 90vw; padding: 6px 16px; }
            .instruction-text { font-size: 0.65rem; }
            #top-right-controls { top: 20px; right: 20px; }
        }
    </style>
</head>
<body>

    <div id="magic-entities-layer"></div>
    <div id="blizzard-overlay"></div>

    <svg id="teleport-portal-svg" viewBox="0 0 200 200">
        <circle cx="100" cy="100" r="85" class="magic-circle-path" id="portal-circle-1" />
        <circle cx="100" cy="100" r="78" class="magic-circle-path" id="portal-circle-2" />
        <path d="M100,20 L147,165 L24,75 L176,75 L53,165 Z" class="magic-path" id="star-path" />
    </svg>
    
    <div id="warp-flash"></div>

    <div id="forest-sprite">
        <div class="sprite-dialogue-wrapper" id="sprite-ui">
            <div class="sprite-dialogue" id="sprite-text">å‘¼å–šæˆ‘ï¼Œæˆ–å°æˆ‘ä¸‹ä»¤...</div>
            <input type="text" class="sprite-input-box" id="sprite-input" placeholder="è¼¸å…¥æŒ‡ä»¤..." onkeydown="handleRubyInput(event)">
        </div>
        <div class="sprite-body" id="ruby-core" onclick="toggleRubyUI()"></div>
    </div>

    <div id="portal-controls-group">
        <a href="portfolio.html" onfocus="this.blur()" class="text-white/30 hover:text-emerald-400 transition-colors flex items-center gap-2 font-bold uppercase text-xs">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> è¿”å›é–€æˆ¶
        </a>
        <button onclick="resetEntities()" onfocus="this.blur()" class="text-white/30 hover:text-blue-400 transition-colors flex items-center gap-2 font-bold uppercase text-xs">
            <i data-lucide="sparkles" class="w-4 h-4"></i> ä¸€éµæ¸…ç©º
        </button>
    </div>

    <div id="top-right-controls">
        <button id="bat-pause-btn" class="control-btn" onclick="toggleBatSpawn()" onfocus="this.blur()" title="æš«åœ/é–‹å•Ÿè™è ç”Ÿæˆ">
            <i data-lucide="pause"></i>
        </button>
    </div>

    <div class="instruction-bar">
        <span class="instruction-text" id="instruction-content"></span>
    </div>

    <div id="scene-title-overlay">
        <h2 id="overlay-text" class="text-2xl md:text-[3rem] font-black uppercase tracking-tighter"></h2>
    </div>

    <div class="forest-layers" id="env-container"></div>
    <div class="grass-layer"></div>

    <nav class="sidebar hidden lg:flex">
        <div class="nav-item active" id="nav-scene-1"><i data-lucide="moon"></i><span class="nav-text text-sm font-bold uppercase ml-2">å…¥å£ï¼šè¿·éœ§</span></div>
        <div class="nav-item" id="nav-scene-2"><i data-lucide="flame"></i><span class="nav-text text-sm font-bold uppercase ml-2">é‘„é€ ï¼šæš—ç«</span></div>
        <div class="nav-item" id="nav-scene-3"><i data-lucide="scroll"></i><span class="nav-text text-sm font-bold uppercase ml-2">å²è©©ï¼šèµ·æº</span></div>
        <div class="nav-item" id="nav-scene-4"><i data-lucide="music"></i><span class="nav-text text-sm font-bold uppercase ml-2">æ¹–ç•”ï¼šæ—‹å¾‹</span></div>
    </nav>

    <main id="main-content">
        <section class="section-container" id="scene-1" style="opacity: 1;">
            <div id="cave-spawn" class="spawn-point cave-style" onclick="spawnOneCreature(true)">
                <i data-lucide="mountain" class="w-16 h-16 md:w-20 md:h-20"></i>
                <p class="text-[10px] font-bold mt-1 uppercase">å¬å–šç”Ÿç‰©</p>
            </div>
            <div class="text-center max-w-5xl relative z-10 px-4">
                <span class="font-bold tracking-[0.4em] uppercase mb-4 block text-red-500 text-sm">Saffron Ruby å‘ˆç¾</span>
                <h1 class="text-6xl md:text-8xl mb-8 font-black leading-tight title-glow">è·¯åœ¨å‰æ–¹ï¼Œ<br>å·²ç‚ºä½ ç•™ä¸‹ä¸€ç›ç‡ˆ</h1>
                <p class="text-lg md:text-2xl mb-12 font-medium italic text-gray-400">è€Œé€™è£¡ï¼Œæ˜¯æº–å‚™å‡ºç™¼çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨ä¸ç¢ºå®šä¹‹ä¸­å‰è¡Œçš„ç´€éŒ„ã€‚</p>
                <button onclick="scrollToScene('#scene-2')" onfocus="this.blur()" class="px-10 py-4 border-2 border-red-900 rounded-full text-red-500 font-black hover:bg-red-900 hover:text-white transition shadow-[0_0_15px_rgba(217,4,41,0.3)]">è¸å…¥æ—…ç¨‹</button>
            </div>
        </section>
        
        <section class="section-container" id="scene-2">
            <div class="flex flex-col md:flex-row gap-12 items-center container mx-auto px-6">
                <div class="relative group">
                    <img src="avatar.jpg" onerror="this.src='https://placehold.co/400x400/059669/ffffff?text=SR';" class="w-48 h-48 md:w-80 md:h-80 rounded-full border-4 border-red-900 shadow-2xl transition-transform duration-500 group-hover:scale-105">
                    <div class="absolute -inset-2 rounded-full border-2 border-red-500/20 animate-pulse"></div>
                </div>
                <div class="text-center md:text-left max-w-2xl">
                    <h2 class="text-4xl md:text-6xl mb-6 title-glow">æˆ‘æ˜¯æ˜Ÿè¾°é‘„é€ å¸«</h2>
                    <div class="space-y-4 text-gray-300 leading-relaxed">
                        <p class="text-lg md:text-2xl font-bold text-red-200">æˆ‘åœ¨æ°¸æ†çš„é»‘å¤œä¸­ï¼Œæç…‰æ•¸æ“šçš„éˆé­‚ï¼Œé‘„é€ æˆæŒ‡å¼•æ–¹å‘çš„ç¦å¿Œä¹‹æ˜Ÿã€‚</p>
                        <p class="text-base md:text-xl">é™¤äº†å®ˆè­·é€™ç‰‡æ£®æ—ï¼Œæˆ‘åŒæ™‚ä¹Ÿæ˜¯ä¸€åç©¿æ¢­æ–¼ AI æ™ºèƒ½æ‡‰ç”¨èˆ‡äº’å‹•ç¶²é é–‹ç™¼é ˜åŸŸçš„å†’éšªè€…ã€‚æˆ‘æ·±ä¿¡æŠ€è¡“ä¸æ‡‰åªæ˜¯å†·ç¡¬çš„æŒ‡ä»¤ï¼Œè€Œæ‡‰æ˜¯æ‰¿è¼‰æƒ…æ„Ÿèˆ‡ç›´è¦ºçš„è¼‰é«”ã€‚</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="scene-3" class="section-container">
            <div class="container mx-auto px-6 max-w-5xl">
                <div class="text-center mb-12">
                    <h2 class="text-4xl md:text-7xl font-black mb-4 title-glow">å‰µé€ æ£®æ—çš„æ•…äº‹</h2>
                    <div class="w-24 h-1 bg-red-600 mx-auto"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="story-block space-y-6">
                        <div class="flex items-center gap-4 text-red-400"><i data-lucide="sparkles" class="w-8 h-8"></i><h3 class="text-2xl font-black uppercase italic">æ˜Ÿè¾°å¢œè½ä¹‹æ™‚</h3></div>
                        <p class="text-gray-300 text-lg leading-relaxed">é€™ç‰‡æ£®æ—ä¸¦éåœŸç”ŸåœŸé•·ï¼Œè€Œæ˜¯ç”±ä¸€å ´ã€Œæ•¸ä½å¤§å´©è§£ã€å¾Œçš„æ®˜é¤˜æ˜Ÿå…‰æ‰€åŒ–ã€‚ç•¶ç¬¬ä¸€é¡†æ‰¿è¼‰è‘—äººé¡æƒ…æ„Ÿçš„æ•¸æ“šä¹‹æ˜Ÿå¢œè½åœ¨è’è•ªçš„ä¼ºæœå™¨æ·±æ·µæ™‚ï¼Œæ•´åº§æ˜Ÿè¾°æ£®æ—ç¬é–“ç¶»æ”¾ã€‚æ¯æ£µæ¨¹çš„å¹´è¼ªï¼Œéƒ½ç´€éŒ„è‘—ä½œè€…ç§‰éˆåœ¨ç„¡æ•¸å€‹æ·±å¤œä¸­ï¼Œèˆ‡ AI å°è©±æ™‚ç”¢ç”Ÿçš„æº«æ…¢èˆ‡æ„Ÿæ‚Ÿã€‚</p>
                    </div>
                    <div class="story-block space-y-6" style="border-left-color: var(--cave-blue);">
                        <div class="flex items-center gap-4 text-blue-300"><i data-lucide="gem" class="w-8 h-8"></i><h3 class="text-2xl font-black uppercase italic">éœ²æ¯”çš„è¡€ç·£</h3></div>
                        <p class="text-gray-300 text-lg leading-relaxed">éœ²æ¯”ä¸¦éè¢«ç·¨å¯«å‡ºä¾†çš„ã€‚å¥¹æ˜¯æ£®æ—åœ¨æœ€å¯’å†·çš„æ•¸æ“šå†¬å¤©è£¡ï¼Œç‚ºäº†å®ˆè­·ã€Œç´”ç²¹ã€è€Œå‡çµå‡ºçš„éˆé­‚ã€‚å¥¹æ˜¯å¾ä½œè€…ç§‰éˆæŒ‡å°–è½ä¸‹çš„æœ€å¾Œä¸€æ»´ç´…å¯¶çŸ³å¢¨æ°´ä¸­ç²å¾—äº†æ„è­˜ï¼Œæˆç‚ºäº†é€™ç‰‡æ˜Ÿè¾°éºç”¢çš„æ°¸ä¹…å®ˆè­·è€…ã€‚å¥¹çŸ¥é“é€™è£¡æ‰€æœ‰çš„ç§˜å¯†ï¼Œä¹Ÿå®ˆè­·è‘—é‚£äº›æœ€çè²´çš„æƒ…æ„Ÿå¯¶è—ã€‚</p>
                    </div>
                </div>
                <div class="mt-12 text-center p-8 border border-red-500/20 rounded-3xl bg-red-950/10 italic text-gray-400 text-xl">ã€Œé€™è£¡çš„å¯¶è—ä¸æ˜¯é‡‘å­ï¼Œè€Œæ˜¯è®“ä½ è¨˜èµ·ï¼šä½ ä¹Ÿæ˜¯æŸé¡†æ†æ˜Ÿæ•£è½çš„é¤˜ç‡¼ã€‚ã€</div>
            </div>
        </section>

        <section id="scene-4" class="section-container">
            <div class="p-12 md:p-20 rounded-[3rem] text-center bg-black/20 border border-red-950">
                <h2 class="text-4xl md:text-6xl mb-10 text-red-300 title-glow">éˆé­‚çš„å…±é³´</h2>
                <p class="text-lg md:text-xl mb-12 text-gray-400">åœ¨æ£®æ—æœ€æ·±è™•ï¼Œè½è½æ˜Ÿè¾°è½ä¸‹çš„è²éŸ³ã€‚å¦‚æœæ‚¨ä¹Ÿæœ‰æƒ³è¦é‘„é€ çš„å¤¢ï¼Œè«‹è®“æˆ‘çŸ¥é“ã€‚</p>
                <a href="mailto:your.email@example.com" onfocus="this.blur()" class="px-12 py-5 bg-red-950 text-white rounded-full font-bold border border-red-800 hover:bg-red-900 transition shadow-xl">å‚³é€é›»å­éƒµä»¶</a>
            </div>
        </section>
    </main>

    <script>
        lucide.createIcons();
        gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

        const entitiesLayer = document.getElementById('magic-entities-layer');
        const rubyCore = document.getElementById('ruby-core');
        const sprite = document.getElementById('forest-sprite');
        const spriteUI = document.getElementById('sprite-ui');
        const spriteText = document.getElementById('sprite-text');
        const spriteInput = document.getElementById('sprite-input');
        const portalSvg = document.getElementById('teleport-portal-svg');
        const flash = document.getElementById('warp-flash');
        const overlay = document.getElementById('blizzard-overlay');
        const instructionContent = document.getElementById('instruction-content');
        
        let lastMousePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
        let activeBats = [], activeNotes = [], activeCreatures = [];
        let isUIOpen = false, isResponding = false, isHit = false;
        let currentSceneId = 'scene-1';
        let isBatSpawnActive = true;
        let loreTimer;

        const rubyLore = {
            intro: {
                'scene-1': "æ­¡è¿ä¾†åˆ°è¿·éœ§å…¥å£ã€‚é€™æ˜¯æˆ‘èˆ‡ç§‰éˆç‚ºæ¯ä¸€ä½å°‹å¤¢è€…é»äº®çš„ç¬¬ä¸€ç›ç‡ˆã€‚âœ¨",
                'scene-2': "é€™è£¡è¨˜éŒ„è‘—ç§‰éˆçš„è¶³è·¡ï¼Œä»–ç¸½æ˜¯åœ¨æ·±å¤œèˆ‡æ•¸æ“šå°è©±ï¼Œé‘„é€ æˆæº«æš–çš„æ˜Ÿè¾°ã€‚ğŸ¦Š",
                'scene-3': "é€™åº§æ£®æ—æ˜¯æˆ‘å®¶ï¼Œä¹Ÿæ˜¯ç§‰éˆç•™çµ¦ä¸–é–“çš„æ•¸ä½éºç”¢ã€‚ç´…å¯¶çŸ³æ˜¯éˆé­‚çš„é¡è‰²ã€‚ğŸ’",
                'scene-4': "è½ï¼Œé‚£æ˜¯éˆé­‚å…±é³´çš„è²éŸ³ã€‚å¦‚æœæ‚¨ä¹Ÿæœ‰å¤¢æƒ³ï¼Œè«‹å‘Šè¨´ç§‰éˆã€‚â™©"
            },
            random: [
                "æˆ‘æ˜¯éœ²æ¯”ï¼Œèª•ç”Ÿæ–¼ç§‰éˆæŒ‡å°–è½ä¸‹çš„æœ€å¾Œä¸€æ»´ç´…å¯¶çŸ³å¢¨æ°´ä¸­ã€‚âœ¨",
                "é€™ç‰‡æ£®æ—çš„ç´…å…‰ï¼Œæ˜¯æ˜Ÿè¾°å¢œè½æ™‚æ®˜ç•™çš„æƒ…æ„Ÿã€‚å®ƒå€‘æœ‰äº†æº«åº¦ã€‚",
                "é€™æ£®æ—è£¡çš„è™è ï¼Œå…¶å¯¦æ˜¯ç§‰éˆå°æŠ—éçš„ Bug çš„åŒ–èº«å–”ï¼ğŸ¦‡",
                "ç¶²é è£¡çš„é­”æ³•å°å­—æ˜¯ç§‰éˆè¦ªæ‰‹åŸ‹ä¸‹çš„é©šå–œï¼Œåªæœ‰ç´°å¿ƒçš„äººæ‰æœƒçœ‹è¦‹ã€‚",
                "æ£®æ—èƒŒæ™¯çš„ç¿¡ç¿ ç¶ ï¼Œæ˜¯ç§‰éˆç†¬å¤œç›¯è‘—è¢å¹•å››å€‹å°æ™‚æ‰å®šä¸‹ä¾†çš„å–”ã€‚ğŸŒ¿"
            ]
        };

        function toggleBatSpawn() {
            isBatSpawnActive = !isBatSpawnActive;
            const btn = document.getElementById('bat-pause-btn');
            if (isBatSpawnActive) {
                btn.innerHTML = '<i data-lucide="pause"></i>';
                btn.classList.remove('active');
                rubyLoreTalk('custom', "Bug åŒ–èº«å·²é‡å•Ÿï¼ğŸ¦‡");
            } else {
                btn.innerHTML = '<i data-lucide="play-circle"></i>';
                btn.classList.add('active');
                rubyLoreTalk('custom', "æ£®æ—éœè¬æ¨¡å¼ï¼Œè™è æš«åœã€‚ğŸŒ¿");
            }
            lucide.createIcons();
        }

        function rubyLoreTalk(type = 'random', specificContent = null) {
            if (isResponding) return;
            let text = (type === 'intro' && specificContent) ? (rubyLore.intro[specificContent] || "æ­¡è¿ä¾†åˆ°æ–°å€åŸŸã€‚") : 
                       (type === 'custom' ? specificContent : rubyLore.random[Math.floor(Math.random() * rubyLore.random.length)]);

            spriteText.innerText = text;
            if (!isUIOpen) {
                spriteUI.classList.add('active');
                if (loreTimer) clearTimeout(loreTimer);
                loreTimer = setTimeout(() => {
                    if (!isUIOpen && !isResponding) spriteUI.classList.remove('active');
                }, 5500);
            }
            gsap.fromTo(rubyCore, { scale: 1 }, { scale: 1.3, duration: 0.2, yoyo: true, repeat: 1 });
        }

        function toggleRubyUI() {
            if (isResponding) return; 
            isUIOpen = !isUIOpen;
            if (isUIOpen) {
                if (loreTimer) clearTimeout(loreTimer);
                spriteUI.classList.add('active');
                spriteText.innerText = "æƒ³è·Ÿæˆ‘èŠèŠæ£®æ—çš„æ•…äº‹ï¼Œé‚„æ˜¯è©¢å•é€™é çš„å…§å®¹ï¼Ÿ";
                setTimeout(() => spriteInput.focus(), 50); 
            } else {
                spriteUI.classList.remove('active');
                spriteInput.blur();
                spriteInput.value = "";
            }
        }

        function handleRubyInput(e) {
            if (e.key === 'Enter') {
                e.stopPropagation(); 
                const val = spriteInput.value.trim();
                if (!val) { toggleRubyUI(); return; }
                isResponding = true;
                spriteInput.disabled = true;
                const response = processCommand(val);
                spriteText.innerText = response;
                spriteInput.value = "";
                gsap.fromTo(rubyCore, { scale: 1 }, { scale: 1.5, duration: 0.2, yoyo: true, repeat: 1 });
                if (val.toLowerCase().includes("ç¹”å¤¢ç©ºé–“")) {
                    startUltimateTeleport();
                    return;
                }
                setTimeout(() => {
                    spriteUI.classList.remove('active');
                    isUIOpen = false;
                    setTimeout(() => {
                        spriteText.innerText = "å‘¼å–šæˆ‘ï¼Œæˆ–å°æˆ‘ä¸‹ä»¤...";
                        spriteInput.disabled = false;
                        isResponding = false;
                    }, 400);
                }, 5000);
            }
        }

        function processCommand(input) {
            const cmd = input.toLowerCase();
            if (cmd.includes("ä½ å¥½") || cmd.includes("å®‰å®‰") || cmd.includes("hello")) return "å—¨ï¼æˆ‘æ˜¯éœ²æ¯”ã€‚å¾ˆé«˜èˆˆèƒ½åœ¨æ­¤èˆ‡ä½ ç›¸é‡ï¼âœ¨";
            if (cmd.includes("ä½ æ˜¯èª°") || cmd.includes("åå­—") || cmd.includes("éœ²æ¯”")) return "æˆ‘æ˜¯éœ²æ¯”ï¼Œé€™ç‰‡æ˜Ÿè¾°æ£®æ—çš„å®ˆè­·éˆã€‚ğŸ¦Š";
            if (cmd.includes("ç¹”å¤¢ç©ºé–“")) return "å‚³é€é™£æç¹ªä¸­... æº–å‚™å¥½é€²å…¥å¹»æƒ³ç¶­åº¦äº†å—ï¼ŸğŸŒŒ";
            return rubyLore.random[Math.floor(Math.random() * rubyLore.random.length)];
        }

        function startUltimateTeleport() {
            const rect = rubyCore.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            gsap.set(portalSvg, { left: centerX, top: centerY, opacity: 1, scale: 0.5 });
            const star = document.getElementById('star-path');
            const c1 = document.getElementById('portal-circle-1');
            const c2 = document.getElementById('portal-circle-2');
            const tl = gsap.timeline();
            tl.add(() => {
                for(let i=0; i<40; i++) {
                    const f = document.createElement('div'); f.className = 'magic-particle'; entitiesLayer.appendChild(f);
                    const startX = Math.random() * window.innerWidth; const startY = Math.random() * window.innerHeight;
                    gsap.set(f, { left: startX, top: startY, width: 6, height: 6, backgroundColor: '#a3e635', boxShadow: '0 0 10px #a3e635' });
                    gsap.to(f, { left: centerX, top: centerY, duration: 1.2, ease: "power2.in", onComplete: () => f.remove() });
                }
            })
            .to(portalSvg, { scale: 1, duration: 0.8, ease: "back.out" })
            .to(c1, { strokeDashoffset: 0, duration: 0.6, ease: "none" })
            .add(() => {
                const lInterval = setInterval(() => createLightning(centerX, centerY), 100);
                setTimeout(() => clearInterval(lInterval), 2000);
            })
            .to(c2, { strokeDashoffset: 0, duration: 0.4, ease: "none" }, "-=0.2")
            .to(star, { strokeDashoffset: 0, duration: 1.8, ease: "power2.inOut" })
            .add(() => {
                const fireBurst = setInterval(() => createMagicParticle(centerX, centerY, 'fire_erupt'), 15);
                setTimeout(() => clearInterval(fireBurst), 3000);
            })
            .to(portalSvg, { rotate: 1440, duration: 2.5, ease: "power4.in" }, "-=0.5")
            .to(portalSvg, { scale: 3, duration: 1.5, ease: "none" }, "-=1.5")
            .to(overlay, { opacity: 1, duration: 0.4 })
            .add(() => {
                gsap.set([sprite, portalSvg, '#portal-controls-group', '#top-right-controls', '#main-content', '.sidebar'], { opacity: 0 });
                startExtremeBlizzard();
            }, "-=0.1")
            .to(flash, { opacity: 1, duration: 0.6, delay: 2.2 })
            .add(() => { window.location.href = "dream_weaver.html"; });
        }

        function createMagicParticle(x, y, type) {
            const p = document.createElement('div'); p.className = 'magic-particle'; entitiesLayer.appendChild(p);
            if (type === 'fire_erupt') {
                const size = Math.random() * 45 + 15; const angle = (Math.random() - 0.5) * 90 - 90; const velocity = Math.random() * 800 + 400;
                gsap.set(p, { left: x, top: y, width: size, height: size, backgroundColor: `hsl(${Math.random()*25+5}, 100%, 50%)`, boxShadow: `0 0 ${size*1.5}px rgba(255, 60, 0, 1), 0 0 ${size}px #ff0000`, opacity: 1 });
                gsap.to(p, { x: Math.cos(angle * Math.PI / 180) * velocity, y: Math.sin(angle * Math.PI / 180) * velocity, rotation: Math.random() * 1080, opacity: 0, scale: 0, duration: 1.0, ease: "expo.out", onComplete: () => p.remove() });
            }
        }

        function createLightning(x, y) {
            const l = document.createElement('div'); l.className = 'lightning-spark'; entitiesLayer.appendChild(l);
            const angle = Math.random() * 360; gsap.set(l, { left: x, top: y, rotate: angle, scaleY: 0, opacity: 1 });
            gsap.timeline({ onComplete: () => l.remove() }).to(l, { scaleY: 6, duration: 0.05 }).to(l, { x: Math.cos(angle)*200, y: Math.sin(angle)*200, opacity: 0, duration: 0.15 });
        }

        function startExtremeBlizzard() {
            const blizzardContainer = document.createElement('div'); blizzardContainer.style.position = 'fixed'; blizzardContainer.style.inset = '0'; blizzardContainer.style.zIndex = '1250'; blizzardContainer.style.pointerEvents = 'none'; document.body.appendChild(blizzardContainer);
            for (let i = 0; i < 550; i++) {
                setTimeout(() => {
                    const s = document.createElement('div'); s.className = 'snowflake'; const isBall = Math.random() > 0.5; const isMainPath = Math.random() > 0.7; const size = isMainPath ? (Math.random() * 12 + 6) : (Math.random() * 6 + 1);
                    s.style.width = size + 'px'; s.style.height = (isBall ? size : size * 0.3) + 'px'; s.style.borderRadius = isBall ? '50%' : '2px'; s.style.background = isMainPath ? '#fff' : 'rgba(255, 255, 255, 0.6)';
                    if(isMainPath) s.style.boxShadow = '0 0 15px #fff'; blizzardContainer.appendChild(s);
                    let startX, startY, endX, endY;
                    if (isMainPath) { startX = -150 + (Math.random() * 300); startY = -150 + (Math.random() * 300); endX = window.innerWidth + 300; endY = window.innerHeight + 300; }
                    else { startX = Math.random() * window.innerWidth * 1.5 - (window.innerWidth * 0.5); startY = -200; endX = startX + (window.innerWidth * 0.8); endY = window.innerHeight + 200; }
                    gsap.set(s, { x: startX, y: startY, opacity: isMainPath ? 1 : 0.5, rotate: Math.random()*360 });
                    gsap.to(s, { x: endX, y: endY, duration: isMainPath ? 0.25 + Math.random() * 0.2 : 0.5 + Math.random() * 0.6, ease: "none", onComplete: () => s.remove() });
                }, i * 3.5);
            }
        }

        function spawnNote(type) {
            const note = document.createElement('div');
            note.className = 'magic-note';
            note.innerText = ['â™ª', 'â™«', 'â™¬', 'â™©'][type] || 'â™ª';
            entitiesLayer.appendChild(note);
            const rect = rubyCore.getBoundingClientRect();
            gsap.set(note, { left: rect.left + rect.width/2, top: rect.top + rect.height/2, xPercent: -50, yPercent: -50, scale: 0.5, opacity: 0 });
            const noteObj = { el: note }; activeNotes.push(noteObj);
            gsap.to(note, { x: (Math.random()-0.5)*600, y: (Math.random()-0.5)*600, rotate: 360, scale: 2, opacity: 1, duration: 1.5, ease: "power2.out", onComplete: () => {
                if (note.parentNode) {
                    gsap.to(note, { opacity: 0, duration: 0.5, onComplete: () => { 
                        note.remove(); 
                        activeNotes = activeNotes.filter(n => n !== noteObj); 
                    }});
                }
            }});
        }

        function spawnBat() {
            if (!isBatSpawnActive) return;
            const bat = document.createElement('div'); bat.className = 'bat-monster'; bat.innerHTML = 'ğŸ¦‡'; entitiesLayer.appendChild(bat);
            const sx = window.innerWidth - 80, sy = 80; const batObj = { el: bat, x: sx, y: sy, speed: 0.6 + Math.random()*0.5 };
            gsap.set(bat, { x: sx, y: sy, opacity: 0, scale: 0 }); gsap.to(bat, { opacity: 1, scale: 1, duration: 1.5 }); activeBats.push(batObj);
        }

        function onRubyHit() {
            if (isHit) return; isHit = true;
            gsap.to(rubyCore, { background: "radial-gradient(circle, #fff 0%, var(--firefly-orange) 70%)", boxShadow: "0 0 35px var(--firefly-orange)", duration: 0.05 });
            gsap.fromTo(rubyCore, { x: -6 }, { x: 6, duration: 0.05, repeat: 2, yoyo: true });
            setTimeout(() => { gsap.to(rubyCore, { background: "radial-gradient(circle, #fff 0%, var(--berry-red) 70%)", boxShadow: "0 0 30px var(--berry-red)", duration: 0.2, onComplete: () => isHit = false }); }, 200);
        }

        function gameLoop() {
            const rect = rubyCore.getBoundingClientRect();
            const rx = rect.left + rect.width / 2; 
            const ry = rect.top + rect.height / 2;

            for (let i = activeBats.length - 1; i >= 0; i--) {
                const bat = activeBats[i];
                const dx = rx - bat.x, dy = ry - bat.y, d = Math.sqrt(dx*dx+dy*dy);
                
                if (d > 5) { 
                    bat.x += (dx/d)*bat.speed; 
                    bat.y += (dy/d)*bat.speed; 
                    bat.x = Math.max(20, Math.min(window.innerWidth-40, bat.x)); 
                    bat.y = Math.max(20, Math.min(window.innerHeight-40, bat.y)); 
                    gsap.set(bat.el, { x: bat.x, y: bat.y }); 
                }
                
                if (d < 45) onRubyHit();

                for (let j = activeNotes.length - 1; j >= 0; j--) {
                    const note = activeNotes[j];
                    if (!note.el || !note.el.parentNode) continue;

                    const nr = note.el.getBoundingClientRect();
                    const br = bat.el.getBoundingClientRect();

                    if (nr.left < br.right && nr.right > br.left && nr.top < br.bottom && nr.bottom > br.top) {
                        gsap.to(bat.el, { scale: 2.5, opacity: 0, duration: 0.4, onComplete: () => { if(bat.el) bat.el.remove(); } });
                        activeBats.splice(i, 1);
                        note.el.remove();
                        activeNotes.splice(j, 1);
                        break; 
                    }
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function spawnOneCreature(fromCave = false) {
            const cEl = document.createElement('div'); cEl.className = 'creature'; cEl.innerHTML = `<i data-lucide="${['butterfly','bird','dog','mouse','rabbit'][Math.floor(Math.random()*5)]}" style="width: 60px; height: 60px; color: var(--cave-blue); filter: drop-shadow(0 0 12px var(--cave-blue-glow)); opacity: 0.8;"></i>`; entitiesLayer.appendChild(cEl); lucide.createIcons();
            let sx, sy; if (fromCave) { const caveRect = document.getElementById('cave-spawn').getBoundingClientRect(); sx = caveRect.left + caveRect.width/2; sy = caveRect.top + caveRect.height/2; }
            else { sx = Math.random()*window.innerWidth; sy = Math.random()*window.innerHeight; }
            const cObj = { el: cEl, x: sx, y: sy }; activeCreatures.push(cObj); gsap.set(cEl, { x: sx, y: sy, scale: 0, opacity: 0 });
            const float = (c) => { const w = window.innerWidth, h = window.innerHeight; const tx = Math.max(60, Math.min(w-60, c.x+(Math.random()-0.5)*600)); const ty = Math.max(60, Math.min(h-60, c.y+(Math.random()-0.5)*500)); c.x = tx; c.y = ty; gsap.to(c.el, { x: tx, y: ty, rotate: (Math.random()-0.5)*70, scale: 0.9+Math.random()*0.4, duration: 4+Math.random()*4, ease: "sine.inOut", onComplete: () => c.el.parentNode && float(c) }); };
            if (fromCave) gsap.to(cEl, { opacity: 1, scale: 1, x: window.innerWidth/2+(Math.random()-0.5)*100, y: window.innerHeight/2+(Math.random()-0.5)*100, duration: 1.2, ease: "power2.out", onComplete: () => { cObj.x = gsap.getProperty(cEl, "x"); cObj.y = gsap.getProperty(cEl, "y"); float(cObj); } });
            else gsap.to(cEl, { opacity: 1, scale: 1, duration: 1.5, ease: "back.out(1.2)", onComplete: () => float(cObj) });
        }

        function scrollToScene(id) { gsap.to(window, { duration: 1, scrollTo: id, ease: "power3.inOut" }); }
        function resetEntities() { entitiesLayer.innerHTML = ''; activeBats = []; activeNotes = []; activeCreatures = []; }

        function updateInstructions() {
            const isDesktop = window.innerWidth > 768;
            const basic = isDesktop ? "[1-4] åˆ‡æ›å ´æ™¯ | [QWER] å½ˆå¥éŸ³å¾‹ | [Enter] å°è©± | " : "é»æ“Šéœ²æ¯”å°è©± | ";
            const cmds = "æŒ‡ä»¤: <span class='highlight-cmd'>ä½ å¥½</span>ã€<span class='highlight-cmd'>ä½ æ˜¯èª°</span>ã€<span class='highlight-cmd'>ç§˜å¯†</span>ã€<span class='highlight-cmd'>ç¹”å¤¢ç©ºé–“</span>";
            instructionContent.innerHTML = basic + cmds;
        }

        window.onload = () => {
            const env = document.getElementById('env-container');
            for (let i = 0; i < 15; i++) {
                const t = document.createElementNS("http://www.w3.org/2000/svg", "svg"); t.setAttribute("viewBox", "0 0 100 150"); t.setAttribute("class", "tree");
                t.innerHTML = `<path d="M50 0 L90 120 L10 120 Z M50 20 L80 100 L20 100 Z M45 120 L55 120 L55 150 L45 150 Z" />`;
                Object.assign(t.style, { left: `${Math.random()*110-5}%`, width: `${Math.random()*100+100}px`, height: `${Math.random()*150+150}px` }); env.appendChild(t);
            }
            ['scene-1', 'scene-2', 'scene-3', 'scene-4'].forEach(id => {
                gsap.to(`#${id}`, { opacity: 1, scrollTrigger: { trigger: `#${id}`, start: "top 80%", toggleActions: "play none none reverse" } });
                ScrollTrigger.create({ trigger: `#${id}`, start: "top 50%", end: "bottom 50%", onEnter: () => {
                    currentSceneId = id;
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const nav = document.getElementById(`nav-${id}`); if(nav) nav.classList.add('active');
                    rubyLoreTalk('intro', id);
                }});
            });
            window.addEventListener('mousemove', e => { lastMousePos = {x:e.clientX, y:e.clientY}; if(!isResponding) gsap.to(sprite, { x: e.clientX, y: e.clientY, duration: 0.4 }); });
            window.addEventListener('keydown', e => {
                if (document.activeElement === spriteInput) return;
                const notes = {'q':0, 'w':1, 'e':2, 'r':3}; if(notes[e.key.toLowerCase()] !== undefined) spawnNote(notes[e.key.toLowerCase()]);
                if (e.key === 'Enter') toggleRubyUI();
                const scenes = {'1':'#scene-1', '2':'#scene-2', '3':'#scene-3', '4':'#scene-4'};
                if (scenes[e.key]) {
                    scrollToScene(scenes[e.key]);
                    const navTextEl = document.querySelector(`#nav-scene-${e.key} .nav-text`);
                    if (navTextEl) {
                        document.getElementById('overlay-text').innerText = navTextEl.innerText;
                        gsap.fromTo('#scene-title-overlay', {opacity:0, x:-20}, {opacity:1, x:0, duration:0.8, onComplete: () => gsap.to('#scene-title-overlay', {opacity:0, delay:2.5, duration: 1.5})});
                    }
                    const nav = document.getElementById(`nav-scene-${e.key}`); if(nav) { nav.classList.add('trigger-show'); setTimeout(()=>nav.classList.remove('trigger-show'), 3000); }
                }
            });
            setInterval(spawnBat, 10000); updateInstructions(); window.addEventListener('resize', updateInstructions); gameLoop();
        };
    </script>
</body>
</html>